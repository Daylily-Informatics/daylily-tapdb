{% extends "base.html" %}

{% block title %}TAPDB Admin - {{ obj.euid }}{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h1>{{ obj.euid }}</h1>
    <div>
        {% if obj_type == 'template' %}
        <a href="/create-instance/{{ obj.euid }}" class="btn btn-success">‚ûï Create Instance</a>
        {% endif %}
        {% if obj_type == 'instance' %}
        <a href="/graph?start_euid={{ obj.euid }}" class="btn">üîó View in Graph</a>
        {% endif %}
        {% if permissions and permissions.can_delete_object %}
        <button onclick="deleteObject('{{ obj.euid }}')" class="btn btn-danger">üóëÔ∏è Delete</button>
        {% endif %}
    </div>
</div>

<div class="card">
    <h2 class="card-title">Object Details</h2>
    <table>
        <tr><th style="width: 200px;">ID</th><td>{{ obj.uuid }}</td></tr>
        <tr><th>EUID</th><td>{{ obj.euid }}</td></tr>
        <tr><th>Object Type</th><td><span class="badge badge-{{ obj.category }}">{{ obj_type }}</span></td></tr>
        <tr><th>Name</th><td>{{ obj.name or '-' }}</td></tr>
        <tr><th>Category</th><td><span class="badge badge-{{ obj.category }}">{{ obj.category }}</span></td></tr>
        <tr><th>Type</th><td>{{ obj.type }}</td></tr>
        <tr><th>Subtype</th><td>{{ obj.subtype }}</td></tr>
        <tr><th>Version</th><td>{{ obj.version }}</td></tr>
        <tr><th>Status</th><td>{{ obj.bstatus or '-' }}</td></tr>
        <tr><th>Created</th><td>{{ obj.created_dt.strftime('%Y-%m-%d %H:%M:%S') if obj.created_dt else '-' }}</td></tr>
        <tr><th>Modified</th><td>{{ obj.modified_dt.strftime('%Y-%m-%d %H:%M:%S') if obj.modified_dt else '-' }}</td></tr>
    </table>
</div>

{% if obj.json_addl %}
<div class="card">
    <h2 class="card-title">Additional Data (JSON)</h2>
    <pre style="background: #0d1117; padding: 1rem; border-radius: 4px; overflow-x: auto; color: #58a6ff;">{{ obj.json_addl | tojson(indent=2) }}</pre>
</div>
{% endif %}

{% if obj_type == 'instance' %}
<div class="card">
    <h2 class="card-title">Parent Relationships ({{ parent_lineages | length }})</h2>
    <p style="color: var(--text-muted); margin-bottom: 1rem;">Objects that this instance is a parent of</p>
    {% if parent_lineages %}
    <table>
        <thead>
            <tr><th>Lineage EUID</th><th>Child EUID</th><th>Child Name</th><th>Relationship</th></tr>
        </thead>
        <tbody>
            {% for lin in parent_lineages %}
            <tr>
                <td><a href="/object/{{ lin.euid }}">{{ lin.euid }}</a></td>
                <td><a href="/object/{{ lin.child_euid }}">{{ lin.child_euid }}</a></td>
                <td>{{ lin.child_name or '-' }}</td>
                <td>{{ lin.relationship_type or 'related' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: var(--text-muted);">No child relationships</p>
    {% endif %}
</div>

<div class="card">
    <h2 class="card-title">Child Relationships ({{ child_lineages | length }})</h2>
    <p style="color: var(--text-muted); margin-bottom: 1rem;">Objects that this instance is a child of</p>
    {% if child_lineages %}
    <table>
        <thead>
            <tr><th>Lineage EUID</th><th>Parent EUID</th><th>Parent Name</th><th>Relationship</th></tr>
        </thead>
        <tbody>
            {% for lin in child_lineages %}
            <tr>
                <td><a href="/object/{{ lin.euid }}">{{ lin.euid }}</a></td>
                <td><a href="/object/{{ lin.parent_euid }}">{{ lin.parent_euid }}</a></td>
                <td>{{ lin.parent_name or '-' }}</td>
                <td>{{ lin.relationship_type or 'related' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="color: var(--text-muted);">No parent relationships</p>
    {% endif %}
</div>
{% endif %}

{% if obj_type == 'lineage' %}
<div class="card">
    <h2 class="card-title">Lineage Details</h2>
    <table>
        <tr>
            <th style="width: 200px;">Parent Instance</th>
            <td>
                {% if obj.parent_instance %}
                <a href="/object/{{ obj.parent_instance.euid }}">{{ obj.parent_instance.euid }}</a>
                ({{ obj.parent_instance.name or '-' }})
                {% else %}-{% endif %}
            </td>
        </tr>
        <tr>
            <th>Child Instance</th>
            <td>
                {% if obj.child_instance %}
                <a href="/object/{{ obj.child_instance.euid }}">{{ obj.child_instance.euid }}</a>
                ({{ obj.child_instance.name or '-' }})
                {% else %}-{% endif %}
            </td>
        </tr>
        <tr><th>Relationship Type</th><td>{{ obj.relationship_type or 'related' }}</td></tr>
    </table>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function deleteObject(euid) {
    if (confirm('Are you sure you want to delete ' + euid + '? This will soft-delete the object.')) {
        fetch('/api/object/' + euid, { method: 'DELETE' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('Object deleted successfully');
                    window.location.href = '/';
                } else {
                    alert('Error: ' + (data.detail || 'Unknown error'));
                }
            })
            .catch(e => alert('Error: ' + e));
    }
}
</script>
{% endblock %}
